---
- name: Clone or update lynis repository
  ansible.builtin.git:
    repo: "{{ security_scans_lynis_repo_url }}"
    dest: "{{ security_scans_lynis_install_path }}"
    version: "{{ security_scans_lynis_branch }}"
    update: true
  become: true

- name: Confirm lynis directory
  ansible.builtin.find:
    paths: "{{ security_scans_lynis_install_path | dirname }}"
    patterns: "{{ security_scans_lynis_install_path | basename }}*"
    recurse: true
    file_type: directory
  register: security_scans_found_directories

- name: Display found lynis directories
  ansible.builtin.debug:
    msg: "{{ [item.path] }}"
  with_items: "{{ security_scans_found_directories.files }}"

- name: Run lynis scan and save to results directory
  ansible.builtin.shell: ./lynis audit system > "{{ security_scans_temp_scan_dir.path }}/lynis.report"
  args:
    chdir: "{{ security_scans_lynis_install_path }}"
  changed_when: true
  become: true

- name: Print report
  ansible.builtin.shell: |
    set -o pipefail &&
    cat "{{ security_scans_temp_scan_dir.path }}/lynis.report" | awk '/- Report data/ {exit} {print}'
  args:
    executable: /bin/bash
  register: security_scans_lynis_report
  changed_when: false
  become: true

- name: Display lynis report
  ansible.builtin.debug:
    msg: "{{ [item] }}"
  with_items: "{{ security_scans_lynis_report.stdout }}"
