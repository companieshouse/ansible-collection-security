---
- name: Extract Lynis hardening index
  ansible.builtin.shell: >
    set -o pipefail &&
    grep "Hardening index" "{{ security_scans_base_dir }}/{{ security_scans_datetime }}/lynis.report" |
    sed 's/\x1b\[[0-9;]*m//g' |
    grep -o '[0-9]\+'
  register: security_scans_lynis_hardening_index
  changed_when: false
  become: true
  failed_when: false

- name: Extract OpenSCAP compliance score
  ansible.builtin.shell: >
    set -o pipefail &&
    sed -n 's/.*<score[^>]*>\([0-9]\+\.[0-9]\+\)<\/score>.*/\1/p'
    {{ security_scans_base_dir }}/{{ security_scans_datetime }}/oscap.xml
    | xargs printf "%.2f\n"
  args:
    executable: /bin/bash
  register: security_scans_cis_compliance_score
  changed_when: false
  become: true
  failed_when: false

- name: Set readable OpenSCAP profile name
  ansible.builtin.set_fact:
    security_scans_oscap_profile_display: >-
      {%- if security_scans_oscap_profile == 'cis_server_l1' -%}
      CIS Level 1{%- elif security_scans_oscap_profile == 'cis' -%}
      CIS Level 2{%- elif security_scans_oscap_profile == 'stig' -%}
      DISA STIG{%- else -%}
      {{ security_scans_oscap_profile | upper }}{%- endif -%}

- name: Set readable datetime
  ansible.builtin.command: date -u '+%Y-%m-%d %H:%M:%S UTC'
  register: security_scans_datetime_readable
  changed_when: false

- name: Set security scan scores as usable parameters
  ansible.builtin.set_stats:
    data:
      LYNIS_SCORE: "{{ security_scans_lynis_hardening_index.stdout | default('N/A') }}"
      OSCAP_SCORE: "{{ security_scans_cis_compliance_score.stdout | default('N/A') }}"
      OSCAP_PROFILE_DISPLAY: "{{ security_scans_oscap_profile_display }}"

- name: Generate Slack notification file
  ansible.builtin.template:
    src: slack-notification.json.j2
    dest: /tmp/security-scans-result.json
    mode: "0644"

- name: Create security scans summary
  ansible.builtin.shell: |
    printf "Scan finished at \033[1m{{ security_scans_datetime_readable.stdout }}\033[0m\n"
    printf "Lynis Hardening Index: \033[1m{{ security_scans_lynis_hardening_index.stdout | default('N/A') }}%%\033[0m\n"
    printf "OpenSCAP {{ security_scans_oscap_profile_display }} Score: \033[1m{{ security_scans_cis_compliance_score.stdout | default('N/A') }}%%\033[0m\n"
    printf "Full report files available in: \033[1m{{ security_scans_base_dir }}/{{ security_scans_datetime }}/\033[0m\n"
  register: security_scans_summary
  changed_when: false

- name: Display security scans summary
  ansible.builtin.debug:
    msg: ""
  with_items:
    - "\n{{ security_scans_summary.stdout }}"
